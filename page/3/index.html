<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Slorui">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/plugin/bganimation/bg.css">

  

  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" rel="stylesheet" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/20210321171549.jpg">
    <h2 class="author">Slorui</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>65</strong><br>文章</div></a>
      <a href="/categories"><div><strong>10</strong><br>分类</div></a>
      <a href="/tags"><div><strong>15</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main">
  
    <article id="post-redis/新建文件夹/redis发布订阅" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/" class="article-date">
  <time class="post-time" datetime="2021-04-02T06:22:50.062Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">02</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/">redis发布订阅</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/redis/">redis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="redis发布订阅"><a class="markdownIt-Anchor" href="#redis发布订阅"></a> redis发布订阅</h3>
<p>redis发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发生信息，订阅者(sub)接收消息。</p>
<p>redis客户端可以订阅任意数量的频道</p>
<p><code>subscribe channel</code>  订阅一个频道（如果没有，频道会自动创建），每次等待接收三条信息（消息，频道、内容）</p>
<p><code>publish cahnnel message</code> 向频道发送一个信息</p>
<p><code>psubcribe pattern</code> 订阅多个满足pattern的频道</p>
<p><code>unsubscribe channel</code> 取消订阅</p>
<p><code>punsubscribe pattern</code>取消满足pattern的频道</p>
<p>当订阅一个频道后，redis维护一个字典，key就是channel，值是一个链表，维护了订阅频道的客户端</p>
<p>subscribe就是将客户端添加到channel的链表</p>
<p>publish向对应的channel链表所有客户端发送消息</p>
<p>场景：</p>
<ol>
<li>实时消息系统</li>
<li>实时聊天（频道当作聊天室）</li>
<li>订阅、关注系统都可以</li>
</ol>
<p>稍微复杂的场景使用消息中间件MQ做</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/" data-id="cknd877zn000k0kvxd9f5fn85" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-redis/新建文件夹/redis事务" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E4%BA%8B%E5%8A%A1/" class="article-date">
  <time class="post-time" datetime="2021-04-02T06:02:03.208Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">02</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E4%BA%8B%E5%8A%A1/">redis事务</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/redis/">redis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="redis事务"><a class="markdownIt-Anchor" href="#redis事务"></a> redis事务</h3>
<p>redis事务的本质：一直命令的集合。一个事务中所有命令被序列化，事务执行过程种，按顺序执行。</p>
<p>一次性、顺序写、排他性执行一些里列的命令</p>
<p><font color='red'> redis单条命令保存原子性，但事务不保证原子性</font></p>
<p><font color='red'>redis事务没有隔离级别的概念，命令会进入队列，只有发起执行时才执行</font></p>
<p>reids的事务：</p>
<ul>
<li>开启事务（multi）</li>
<li>命令入队（使用命令）</li>
<li>执行事务（exec）</li>
<li>取消事务(discard)</li>
</ul>
<p><font color='red'> redis事务编译时异常，事务会取消</font></p>
<p><font color='red'> redis事务运行时异常，错误命令会报错，不会影响其他命令的执行</font>（需要加锁监控）</p>
<p><code>watch key</code>对key加监视，乐观锁，当执行事务时发现key被修改，事务执行失败</p>
<p><code>unwatch</code>放弃监视</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E4%BA%8B%E5%8A%A1/" data-id="cknd877zk000b0kvx8lme2pgy" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-redis/新建文件夹/redis五大数据类型" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="article-date">
  <time class="post-time" datetime="2021-04-02T05:29:25.357Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">02</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">redis五大数据类型</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/redis/">redis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="redis五大数据类型"><a class="markdownIt-Anchor" href="#redis五大数据类型"></a> redis五大数据类型</h3>
<p>redis是一个内存数据结构存储系统，可以作为数据库、缓存和消息中间件MQ。</p>
<p>redis支持多种数据结构：字符串（String）、散列（hash）、列表（list）、集合（sets）、有序集合（sorted sets）和范围查询，bitmaps、hypeloglogs和地理空间（geospatial）索引半径查询。</p>
<p>redis内置了复制（replication），LUA脚本（lua scripting），LRU驱动事件（LRU eviction）、事务（transaction）和不同级别的持久化（persistence）</p>
<p>redis通过哨兵（Sentinel）和自动分区（Cluster）提供高可用性</p>
<h4 id="string"><a class="markdownIt-Anchor" href="#string"></a> String</h4>
<p><code>append key val</code>往key的value后面追加val，如果不存在key，相对于<code>set key</code></p>
<p><code>strlen key</code>获取key的value的字符串长度</p>
<p><code>incr key</code> key的value值加1</p>
<p><code>derc key</code>key的value值减1</p>
<p><code>incrby key size</code>key的value值加size</p>
<p><code>decrby key size</code>key的value值减size</p>
<p><code>getrange key start stop</code>截取字符串，可以得到stop位置，stop为-1表示全部字符串</p>
<p><code>setrange key start val</code>用val替换key的value从start开始的值</p>
<p><code>setex(set with expire) key second value</code>设置带过期事件的字符串</p>
<p><code>setnx(set if not exist) key value</code>如果不存在就设置，分布式锁常常使用</p>
<p><code>mset k1 v1 k2 v2 k3 v3</code>一次性设置多个 <code>mset user:1:key value user:1:key1 value1</code></p>
<p><code>mget k1 k2 k3</code>一次获取多个</p>
<p><code>msetxnx k1 v1 k2 v2</code>一次设置多个，如果不存在就设置，原子性操作，一个失败全部失败</p>
<p><code>getset key value</code>先获取再设置，不存在就返回nil，存在就获取原值，并设置为新值</p>
<p>使用场景：value是字符串，还可以是数字</p>
<ul>
<li>计数器</li>
<li>统计多单位的数量 uid:keys::value</li>
<li>粉丝数</li>
<li>对象缓存存储</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" data-id="cknd877zl000e0kvx94f7bqi5" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-redis/新建文件夹/redis基础知识" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="article-date">
  <time class="post-time" datetime="2021-04-02T05:14:08.276Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">02</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">redis基础知识</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/redis/">redis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="redis基础知识"><a class="markdownIt-Anchor" href="#redis基础知识"></a> redis基础知识</h4>
<ol>
<li>
<p>共16个数据库，默认使用第0个数据库，使用<code>select x</code>使用不同数据库</p>
</li>
<li>
<p><code>DBSIZE</code>查看当前数据库大小</p>
</li>
<li>
<p><code>keys *</code>查看当前数据库所有的key</p>
</li>
<li>
<p><code>flush all</code>清空全库</p>
</li>
<li>
<p><code>flush db</code>清空当前数据库</p>
</li>
<li>
<p><code>set key value</code>设置key-value</p>
</li>
<li>
<p><code>exists key</code>是否存在一个key</p>
</li>
<li>
<p><code>move key index</code>删除index数据库的key</p>
</li>
<li>
<p><code>clear</code>清空屏幕</p>
</li>
<li>
<p><code>expire key second</code>设置key的过期时间</p>
</li>
<li>
<p><code>ttl key</code>获取key的过期时间</p>
</li>
<li>
<p><code>type key</code>查看key类型</p>
</li>
<li>
<p>为什么redis使用6379作为端口号：明星MERZ九宫格拼写</p>
</li>
<li>
<p>redis是单线程的</p>
</li>
<li>
<p>redis是基于内存操作的，cpu不是redis的性能瓶颈，瓶颈是机器的内存和网络带宽，所以单线程就可以</p>
</li>
<li>
<p>redis单线程还这么快：</p>
<ol>
<li>c语言写的，10w+的QPS，完全不必k-v的memcache差</li>
<li>高性能的服务器不一定是多线程的</li>
<li>多线程不一定比单线程快，多线程会线程切换</li>
<li>redis将所有数据放在内存，所有单线程取操作就是效率最高的，对于内存系统，如果没有上下文切换效率最高。多次读写都是在一个cpu上，在内存下，就是最佳方案</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/02/redis/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" data-id="cknd877zm000h0kvxebet6lsa" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/spring注入" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/29/spring/spring%E6%B3%A8%E5%85%A5/" class="article-date">
  <time class="post-time" datetime="2021-03-29T13:26:10.615Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">29</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/29/spring/spring%E6%B3%A8%E5%85%A5/">spring注入</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="spring注入"><a class="markdownIt-Anchor" href="#spring注入"></a> spring注入</h3>
<h4 id="注入方式"><a class="markdownIt-Anchor" href="#注入方式"></a> 注入方式</h4>
<p>DI（Dependenct Inject）注入一共有两种主要的变体：基于<strong>setter注入</strong>和<strong>基于构造器注入</strong> ，注入都是这两种方式或这两种的变体，例如@autowired，通过Java反射，<code>field.set(val,Object)</code>实现，是一种变体。</p>
<h5 id="基于setter注入"><a class="markdownIt-Anchor" href="#基于setter注入"></a> 基于setter注入</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="comment">// B属性即使没有也可以调用setter方法</span></span><br><span class="line">    B b;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXxx</span><span class="params">(B b)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;spring 找到符合的setter&quot;</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;和属性无关，甚至可以不要属性&quot;</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;可以直接调用，这个A里面就没有任何属性&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>手动注入</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.slorui.app.A&quot;</span> &gt;</span></span><br><span class="line">    // name 对应属性名</span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;b&quot;</span> <span class="attr">ref</span> <span class="attr">bean</span>=<span class="string">&quot;b&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;b&quot;</span>  <span class="attr">class</span>=<span class="string">&quot;com.slorui.app.B&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>自动注入</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">		<span class="comment">// 设置自动注入 也会调用setter</span></span><br><span class="line">        beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id="基于构造器注入"><a class="markdownIt-Anchor" href="#基于构造器注入"></a> 基于构造器注入</h5>
<p><strong>基于构造器的注入与setter注入不同，会在创建bean时选择构造器并调用进行创建，因此即使是手动，也无法通过设置实现对类的忽略</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	B b;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(B b)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.b = b;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>手动注入</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.slorui.app.A&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;b&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;beanThree&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;b&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.slorui.app.B&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>自动注入</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">	<span class="comment">// 设置自动注入 也会调用setter</span></span><br><span class="line">       beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line">       <span class="comment">// 此处设置不生效，无法忽略B</span></span><br><span class="line">       beanFactory.ignoreDependencyType(B.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="注入模式"><a class="markdownIt-Anchor" href="#注入模式"></a> 注入模式</h4>
<p>注入模式和注入方式不同，注入方式是注入的手段（如何注入），注入模式是注入时的行为（通过什么注入）</p>
<ol>
<li><code>AUTOWIRE_NO</code>：不自动注入，是默认的注入模式，值为0</li>
<li><code>AUTOWIRE_BY_NAME</code>：通过Bean名字注入，值为1</li>
<li><code>AUTOWIRE_BY_TYPE</code>：通过Bean类型注入，值为2</li>
<li><code>AUTOWIRE_CONSTRUCTOR</code>：通过构造器注入，值为3</li>
<li><code>AUTOWIRE_AUTODETECT</code>：自动检测，值为4，已经被废弃。</li>
</ol>
<h5 id="设置注入模式"><a class="markdownIt-Anchor" href="#设置注入模式"></a> 设置注入模式</h5>
<ol>
<li>xml</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">default-autowire</span>=<span class="string">&quot;byType&quot;</span>&gt;</span> // 这里设置全局注入模式，当前xml里的都是这种模式</span><br><span class="line">    </span><br><span class="line">    // 这里设置当前Bean的注入模式，会覆盖全局</span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.luban.app.A&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;constructor&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>java配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">	GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">	<span class="comment">// 设置自动注入模式</span></span><br><span class="line">       beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实现原理"><a class="markdownIt-Anchor" href="#实现原理"></a> 实现原理</h5>
<p>sring在<code>populateBean</code>时，会判断注入模式，然后进行对应的注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> resolvedAutowireMode = mbd.getResolvedAutowireMode();</span><br><span class="line"><span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">	MutablePropertyValues newPvs = <span class="keyword">new</span> MutablePropertyValues(pvs);</span><br><span class="line">	<span class="comment">// Add property values based on autowire by name if applicable.</span></span><br><span class="line">	<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">		autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Add property values based on autowire by type if applicable.</span></span><br><span class="line">	<span class="keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">		autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">	&#125;</span><br><span class="line">	pvs = newPvs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="autowired"><a class="markdownIt-Anchor" href="#autowired"></a> @Autowired</h4>
<p><code>@Autowired</code>使用反射进行类的注入，注入时首先通过ByType注入，如果找不到，进行ByName，都找不报错</p>
<h5 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h5>
<ol>
<li>spring容器启动时，<code>AutowiredAnnotationBeanPostProcessor</code>被注册到容器</li>
<li>扫描代码，如果带有@Autowired注解，则将依赖注入信息封装到<code>InjectionMetadata</code>中（见扫描过程）
<ol>
<li>扫描当前类中标注@Autowired的属性和方法</li>
<li>再查找父类中注@Autowired的属性和方法，依次遍历</li>
</ol>
</li>
<li>创建bean时（实例化对象和初始化），会调用各种<code>BeanPostProcessor</code>对bean初始化，<code>AutowiredAnnotationBeanPostProcesso</code>r负责将相关的依赖注入进来</li>
</ol>
<h5 id="执行时机"><a class="markdownIt-Anchor" href="#执行时机"></a> 执行时机</h5>
<ol>
<li><code>AbstractBeanFactory#doCreateBean</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用属性合并后置处理器</span></span><br><span class="line">applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>调用<code>AutowiredAnnotationBeanPostProcessor</code>的后置处理器</li>
<li>``AutowiredAnnotationBeanPostProcessor#findAutowiringMetadata`查找@Autowired元数据</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 创建自动注入元数据</span></span><br><span class="line"><span class="comment">  * 处理被<span class="doctag">@Autowired</span>标记的方法、属性，以及父类被标记的</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	metadata = buildAutowiringMetadata(clazz);</span><br></pre></td></tr></table></figure>
<h4 id="多个候选者的解决方案"><a class="markdownIt-Anchor" href="#多个候选者的解决方案"></a> 多个候选者的解决方案</h4>
<p>当自动注入时发现多个可匹配的类时，spring会报错，解决方案如下</p>
<ol>
<li>设置默认的注入类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">		<span class="comment">// 对于接口C的候选类，默认使用D来注入</span></span><br><span class="line">        beanFactory.registerResolvableDependency(C.class,<span class="keyword">new</span> D());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>设置优先级，使用<code>@primary</code>注解标识要注入的类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Y</span> <span class="keyword">implements</span> <span class="title">X</span></span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>设置优先级，使用<code>@Priority(x)</code>标识类的优先级</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Priority(2)</span> <span class="comment">// 优先级从小到大</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Y</span> <span class="keyword">implements</span> <span class="title">X</span></span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/29/spring/spring%E6%B3%A8%E5%85%A5/" data-id="ckmuoxeyt0000pwvx6mok1rwf" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/beanFactoryAPI" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/29/spring/beanFactoryAPI/" class="article-date">
  <time class="post-time" datetime="2021-03-29T11:40:50.183Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">29</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/29/spring/beanFactoryAPI/">beanFactoryAPI</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="beanfactoryapi"><a class="markdownIt-Anchor" href="#beanfactoryapi"></a> beanFactoryAPI</h3>
<h4 id="获取beanfacotry"><a class="markdownIt-Anchor" href="#获取beanfacotry"></a> 获取BeanFacotry</h4>
<p>通过实现<code>BeanFactoryPostProcessor</code>获得<code>ConfigurableListableBeanFactory</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIgnoreDependencyType</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ignoredependencytype"><a class="markdownIt-Anchor" href="#ignoredependencytype"></a> ignoreDependencyType</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Ignore the given dependency type for autowiring:</span></span><br><span class="line"><span class="comment"> * for example, String. Default is none.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type the dependency type to ignore</span></span><br><span class="line"><span class="comment"> * 忽略自动装配的类型(byType、byName) （CONSTRUCTOR方式不能忽略，再创建bean还没注入时已经把类注入了）</span></span><br><span class="line"><span class="comment"> * 如果属性是自动注入会忽略 但是Autowired不属于自动注入，是手动注入 所以不会被忽略</span></span><br><span class="line"><span class="comment"> * 只能通过修改被注入类的注入模型实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ignoreDependencyType</span><span class="params">(Class&lt;?&gt; type)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// 获取类的beanDefinition</span></span><br><span class="line">    GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置自动注入模型</span></span><br><span class="line">    beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">    <span class="comment">// 设置自动注入时忽略的类</span></span><br><span class="line">    beanFactory.ignoreDependencyType(B.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">	B b;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123;</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;bean-b:&#123;&#125;&quot;</span>,b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ignoredependencyinterface"><a class="markdownIt-Anchor" href="#ignoredependencyinterface"></a> ignoreDependencyInterface</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果类实现了有setX方法的接口，则在（自动注入）时会忽略该类对应的set方法</span></span><br><span class="line"><span class="comment"> * 实现了spring的Aware就是在注入时忽略了（自动注入），而是在调用Aware后置处理器时才会执行对应的set方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ignoreDependencyInterface</span><span class="params">(Class&lt;?&gt; ifc)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;y&quot;</span>);</span><br><span class="line">    beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">    <span class="comment">// 需要在自动注入模式下</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(X.class);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setW</span><span class="params">(W w)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Y</span> <span class="keyword">implements</span> <span class="title">X</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	W w;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setW</span><span class="params">(W w)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 自动注入模式下，通过忽略接口X可以使W不会自动注入</span></span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="registerresolvabledependency"><a class="markdownIt-Anchor" href="#registerresolvabledependency"></a> registerResolvableDependency</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给指定类型的依赖注入特定的值（没有说自动注入，非自动注入也可以）</span></span><br><span class="line"><span class="comment"> * 当有多个注入类型时，这种设置方式可以使得有确定的注入类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerResolvableDependency</span><span class="params">(Class&lt;?&gt; dependencyType, <span class="meta">@Nullable</span> Object autowiredValue)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// 注入c接口时指定使用D类来注入</span></span><br><span class="line">    beanFactory.registerResolvableDependency(C.class,<span class="keyword">new</span> D());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="clearmetadatacache"><a class="markdownIt-Anchor" href="#clearmetadatacache"></a> clearMetadataCache</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清空beanDefinition缓存， 缓存-属性填充时会缓存的bd</span></span><br><span class="line"><span class="comment"> * getBean()时，spring会去把beanDefinitionMap的beanDefinition进行merge</span></span><br><span class="line"><span class="comment"> * 然后放入mergedBeanDefinition</span></span><br><span class="line"><span class="comment"> * 清空缓存就是标记了mergedBeanDefinition需要合并</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearMetadataCache</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>DefaultListableBeanFactory#clearMetadataCache</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearMetadataCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 会判断beanFactory是否被冻结</span></span><br><span class="line"><span class="comment">		 * 如果被冻结，会标记位需要reMerge</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">    <span class="keyword">super</span>.clearMetadataCache();</span><br><span class="line">    <span class="keyword">this</span>.mergedBeanDefinitionHolders.clear();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 因为需要重新merge，所以allBeanNamesByType</span></span><br><span class="line"><span class="comment">	 * 和singletonBeanNamesByType两个map也需要失效</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    clearByTypeCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="freezeconfiguration"><a class="markdownIt-Anchor" href="#freezeconfiguration"></a> freezeConfiguration</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 冻结容器，所有修改只修改到了beanDefinitionMap</span></span><br><span class="line"><span class="comment"> * getBean()获取mergedBeanDefinition不会被修改影响</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freezeConfiguration</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="isconfigurationfrozen"><a class="markdownIt-Anchor" href="#isconfigurationfrozen"></a> isConfigurationFrozen</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否冻结</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isConfigurationFrozen</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="preinstantiatesingletons"><a class="markdownIt-Anchor" href="#preinstantiatesingletons"></a> preInstantiateSingletons</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实例化所以单例bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException</span>;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/29/spring/beanFactoryAPI/" data-id="ckmuoxf260001pwvx9x3975q7" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/mybatis/自定义mybatis扫描" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/27/spring/mybatis/%E8%87%AA%E5%AE%9A%E4%B9%89mybatis%E6%89%AB%E6%8F%8F/" class="article-date">
  <time class="post-time" datetime="2021-03-27T13:45:15.527Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/27/spring/mybatis/%E8%87%AA%E5%AE%9A%E4%B9%89mybatis%E6%89%AB%E6%8F%8F/">自定义mybatis</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/mybatis/">mybatis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="自定义mybatis"><a class="markdownIt-Anchor" href="#自定义mybatis"></a> 自定义mybatis</h3>
<ol>
<li>
<p>创建自定义扫描注解<code>DaoScannerRegister</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(DaoScannerRegister.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DaoScan &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">basePackage</span><span class="params">()</span> </span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建扫描注册器<code>DaoScannerRegister</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoScannerRegister</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过DaoScan注解获取basePackage信息</span></span><br><span class="line">		AnnotationAttributes mapperScanAttrs = AnnotationAttributes</span><br><span class="line">				.fromMap(importingClassMetadata.getAnnotationAttributes(DaoScan.class.getName()));</span><br><span class="line">		String basePackage = mapperScanAttrs.getString(<span class="string">&quot;basePackage&quot;</span>);</span><br><span class="line">        <span class="comment">// 注册DaoScannerConfig类</span></span><br><span class="line">		BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(DaoScannerConfig.class);</span><br><span class="line">		beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;basePackage&quot;</span>,basePackage);</span><br><span class="line">		registry.registerBeanDefinition(<span class="string">&quot;daoScanner&quot;</span>,beanDefinitionBuilder.getBeanDefinition());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建扫描配置类<code>DaoScannerConfig</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现BeanDefinitionRegistryPostProcessor,注册新的BeanDefination</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoScannerConfig</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String basePackage;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScannerConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">// 创建数据域</span></span><br><span class="line">		DriverManagerDataSource driverManagerDataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">		driverManagerDataSource.setDriverClassName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">		driverManagerDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/eesy&quot;</span>);</span><br><span class="line">		driverManagerDataSource.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">		driverManagerDataSource.setPassword(<span class="string">&quot;1234&quot;</span>);</span><br><span class="line">		<span class="comment">// 构建事务工厂</span></span><br><span class="line">		TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">		<span class="comment">// 创建环境</span></span><br><span class="line">		Environment environment = <span class="keyword">new</span> Environment(<span class="string">&quot;development&quot;</span>, transactionFactory, driverManagerDataSource);</span><br><span class="line">		<span class="comment">// 构建配置类</span></span><br><span class="line">		Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line">		<span class="comment">// 获取sqlSession工厂</span></span><br><span class="line">		<span class="keyword">this</span>.sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBasePackage</span><span class="params">(String basePackage)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.basePackage = basePackage;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException 	</span>&#123;</span><br><span class="line">        <span class="comment">// 创建自定义扫描类</span></span><br><span class="line">		DaoScanner daoScanner = <span class="keyword">new</span> DaoScanner(registry);</span><br><span class="line">        <span class="comment">// 增加过滤器 允许SimpleMetadataReader</span></span><br><span class="line">		daoScanner.registerFilters();</span><br><span class="line">        <span class="comment">// 传入sqlSessionFactory</span></span><br><span class="line">		daoScanner.setSqlSessionFactory(<span class="keyword">this</span>.sqlSessionFactory);</span><br><span class="line">        <span class="comment">// 调用spring的扫描方法 然后转到DaoScanner的扫描方法</span></span><br><span class="line">		daoScanner.scan(basePackage);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException 		</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建自定义扫描类<code>DaoScanner</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoScanner</span> <span class="keyword">extends</span> <span class="title">ClassPathBeanDefinitionScanner</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 保持sqlSessionFactory以便传给DaoFactoryBean</span></span><br><span class="line">	<span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionFactory</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 添加过滤器 这里允许了任何类都通过 mybatis也是这样</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerFilters</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">		addIncludeFilter((metadataReader, metadataReaderFactory) -&gt; <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重写父类ClassPathBeanDefinitionScanner的判断，允许接口被候选</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isCandidateComponent</span><span class="params">(AnnotatedBeanDefinition beanDefinition)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> beanDefinition.getMetadata().isInterface() &amp;&amp; beanDefinition.getMetadata().isIndependent();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重写父类扫描</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">doScan</span><span class="params">(String... basePackages)</span> </span>&#123;</span><br><span class="line">		Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">super</span>.doScan(basePackages);</span><br><span class="line">		postProcessBeanDefinition(beanDefinitions);</span><br><span class="line">		<span class="keyword">return</span> beanDefinitions;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 后置处理,将mapper接口的beanDefinition转化为DaoFactoryBean，并传入sqlSessionFactory</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinition</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span></span>&#123;</span><br><span class="line">		GenericBeanDefinition beanDefinition = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">for</span>(BeanDefinitionHolder holder: beanDefinitions)&#123;</span><br><span class="line">			beanDefinition = (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line">			String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">			beanDefinition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);</span><br><span class="line">			beanDefinition.setBeanClass(DaoFactoryBean.class);</span><br><span class="line">			beanDefinition.getPropertyValues().add(<span class="string">&quot;sqlSessionFactory&quot;</span>,<span class="keyword">this</span>.sqlSessionFactory);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry, useDefaultFilters);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters, Environment environment)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry, useDefaultFilters, environment);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters, Environment environment, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry, useDefaultFilters, environment, resourceLoader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建<code>DaoFactoryBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoFactoryBean</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">// 要创建的mapper的接口类型</span></span><br><span class="line">	Class&lt;T&gt; daoInterface;</span><br><span class="line">	</span><br><span class="line">	SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionFactory</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoFactoryBean</span><span class="params">(Class&lt;T&gt; daoInterface)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.daoInterface = daoInterface;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 将mapper保存到knowMapper中，以便后续创建代理对象</span></span><br><span class="line">		sqlSessionFactory.getConfiguration().addMapper(daoInterface);</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory.openSession().getMapper(daoInterface);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="comment">// 这里一定要返回接口类型，不然无法注入</span></span><br><span class="line">		<span class="keyword">return</span> daoInterface;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/27/spring/mybatis/%E8%87%AA%E5%AE%9A%E4%B9%89mybatis%E6%89%AB%E6%8F%8F/" data-id="ckmuoxf2h0004pwvxhw11csps" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/mybatis/mybatis扫描原理" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/27/spring/mybatis/mybatis%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="post-time" datetime="2021-03-27T11:34:16.778Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/27/spring/mybatis/mybatis%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86/">mybatis扫描原理</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/mybatis/">mybatis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="mybatis扫描原理"><a class="markdownIt-Anchor" href="#mybatis扫描原理"></a> mybatis扫描原理</h3>
<ol>
<li>
<p>MapperScan导入了<code>MapperScannerRegistrar</code>类，该类继承了<code>ImportBeanDefinitionRegistrar</code>，可以进行新的<code>beanDefinition</code>注册</p>
<p><img src="images/image-20210327193702843.png" alt="image-20210327193702843" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperScannerRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">ResourceLoaderAware</span></span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>MapperScannerRegistrar</code>注册了<code>MapperScannerConfigurer</code>类，该类实现了<code>BeanDefinitionRegistryPostProcessor</code>，在注册<code>beanDefinition</code>后进行了后置处理</p>
<p><img src="images/image-20210329091956851.png" alt="image-20210329091956851" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperScannerConfigurer</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>, <span class="title">InitializingBean</span>, <span class="title">ApplicationContextAware</span>, <span class="title">BeanNameAware</span></span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>MapperScannerConfigurer</code>的<code>postProcessBeanDefinitionRegistry</code>进行了包扫描</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassPathMapperScanner scanner = <span class="keyword">new</span> ClassPathMapperScanner(registry);</span><br><span class="line">scanner.scan()</span><br></pre></td></tr></table></figure>
<p>**<code>ClassPathMapperScanner</code>是<code>ClassPathBeanDefinitionScanner</code>**的子类，这里scan调用了父类的scan方法，然后执行了子类的doScan</p>
<p><code>ClassPathBeanDefinitionScanner</code></p>
</li>
</ol>
<p><img src="images/image-20210327195223282.png" alt="image-20210327195223282" /></p>
<p><code>ClassPathMapperScanner</code></p>
<p><img src="images/image-20210327195433602.png" alt="image-20210327195433602" /></p>
<ol start="4">
<li>
<p><code>processBeanDefinitions</code>进行了类的替换，把所有的mapper替换成了<code>mapperFacotryBean</code></p>
<p><img src="images/image-20210327195533926.png" alt="image-20210327195533926" /></p>
<ol>
<li>
<p>获取mapper的类名</p>
</li>
<li>
<p>把mapper类放入<code>beanDefinition的</code>构造器中，作为<code>mapperFacotryBean</code>的<code>mapperInterface</code>，进行后续代理注入容器</p>
<p><img src="images/image-20210327195745251.png" alt="image-20210327195745251" /></p>
</li>
<li>
<p>把当前<code>beanDefinition</code>替换为<code>mapperFacotryBean</code></p>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/27/spring/mybatis/mybatis%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86/" data-id="ckmromktc000cawvxgr8t0m7q" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/mybatis/mybatis基本配置" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/27/spring/mybatis/mybatis%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/" class="article-date">
  <time class="post-time" datetime="2021-03-27T06:20:24.316Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/27/spring/mybatis/mybatis%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/">mybatis基本配置</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/mybatis/">mybatis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="mybatis基本配置"><a class="markdownIt-Anchor" href="#mybatis基本配置"></a> mybatis基本配置</h3>
<h4 id="使用xml"><a class="markdownIt-Anchor" href="#使用xml"></a> 使用xml</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/mybatis/example/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">&quot;org/mybatis/example/mybatis-config.xml&quot;</span>;</span><br><span class="line">InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br></pre></td></tr></table></figure>
<h4 id="不使用xml"><a class="markdownIt-Anchor" href="#不使用xml"></a> 不使用xml</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建数据域</span></span><br><span class="line">DataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line"><span class="comment">// 构建事务工厂</span></span><br><span class="line">TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line"><span class="comment">// 创建环境</span></span><br><span class="line">Environment environment = <span class="keyword">new</span> Environment(<span class="string">&quot;development&quot;</span>, transactionFactory, dataSource);</span><br><span class="line"><span class="comment">// 构建配置类</span></span><br><span class="line">Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line"><span class="comment">// 添加mapper文件</span></span><br><span class="line">configuration.addMapper(BlogMapper.class);</span><br><span class="line"><span class="comment">// 获取sqlSession工厂</span></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br></pre></td></tr></table></figure>
<h4 id="执行sql"><a class="markdownIt-Anchor" href="#执行sql"></a> 执行sql</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">Blog blog = (Blog) session.selectOne(<span class="string">&quot;org.mybatis.example.BlogMapper.selectBlog&quot;</span>, <span class="number">101</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BlogMapper mapper = session.getMapper(BlogMapper.class);</span><br><span class="line">Blog blog = mapper.selectBlog(<span class="number">101</span>);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/27/spring/mybatis/mybatis%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/" data-id="ckmromktc000bawvxgc3k02g8" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/动态代理" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/26/spring/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" class="article-date">
  <time class="post-time" datetime="2021-03-26T08:12:42.541Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">26</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/26/spring/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">动态代理</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="动态代理"><a class="markdownIt-Anchor" href="#动态代理"></a> 动态代理</h3>
<h4 id="静态代理"><a class="markdownIt-Anchor" href="#静态代理"></a> 静态代理</h4>
<h5 id="继承"><a class="markdownIt-Anchor" href="#继承"></a> 继承</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberDao</span> <span class="keyword">implements</span> <span class="title">MDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;---------query-----------logic&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> name+<span class="string">&quot;-return&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> * MDaoSubLog：代理类会继承目标类 代理对象是子孩子 目标对象是父亲</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDaoSubLog</span>  <span class="keyword">extends</span> <span class="title">MemberDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;xxx====proxy&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.query(id,name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="接口"><a class="markdownIt-Anchor" href="#接口"></a> 接口</h5>
<ol>
<li><strong>代理类要实现和目标类同一个接口</strong></li>
<li><strong>代理类包含目标对象</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 目标对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberDao</span> <span class="keyword">implements</span> <span class="title">MDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;---------query-----------logic&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> name+<span class="string">&quot;-return&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> * 代理对象 proxyObejct</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDaoTime</span> <span class="keyword">implements</span> <span class="title">MDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 目标对象 targetObject</span></span><br><span class="line"><span class="comment">	 * 这里是逻辑写法 MemberDao memberDao</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	MDao mDao;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化mDao</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mDao</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MDaoTime</span><span class="params">(MDao mDao)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.mDao = mDao;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">		String result = mDao.query(id,name);</span><br><span class="line">		log.debug(<span class="string">&quot;xxx====proxy&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="缺点"><a class="markdownIt-Anchor" href="#缺点"></a> 缺点</h5>
<ol>
<li>会产生很多代理类</li>
<li>产生的代理类只能代理既定的接口</li>
</ol>
<h4 id="动态代理-2"><a class="markdownIt-Anchor" href="#动态代理-2"></a> 动态代理</h4>
<h5 id="接口-2"><a class="markdownIt-Anchor" href="#接口-2"></a> 接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">MDao memberDao = <span class="keyword">new</span> MemberDao();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * newPorxyInstance</span></span><br><span class="line"><span class="comment">		 * 1. 产生一段字符串 代理类的源码</span></span><br><span class="line"><span class="comment">		 * 2. 把字符串输出到.java($Proxy.java)文件中</span></span><br><span class="line"><span class="comment">		 * 3. 会把$Proxy.class动态编译成$Proxy.class文件</span></span><br><span class="line"><span class="comment">		 * 4. 会通过类加载器把$Proxy.class加载到JVM中</span></span><br><span class="line"><span class="comment">		 * 5. Class.forName(&quot;XXXX&quot;).newInstance 反射实例化这个对象</span></span><br><span class="line"><span class="comment">		 * 6. 直接在内存中产生了字节码，然后装载到jvm</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		MDao mDao = (MDao) Proxy.newProxyInstance(Test.class.getClassLoader(),</span><br><span class="line">				<span class="keyword">new</span> Class[]&#123;MDao.class&#125;,</span><br><span class="line">				<span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">						log.debug(<span class="string">&quot;before--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">						method.invoke(memberDao, args);</span><br><span class="line">						log.debug(<span class="string">&quot;after--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">		mDao.query(<span class="number">1</span>,<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 把内存字节码输出到文件 就可以看到代理类的内容</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// 获取当前类的跟路径</span></span><br><span class="line">		URL resource = Test.class.getClass().getResource(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">		<span class="comment">// 获取代理类的字节</span></span><br><span class="line">		<span class="keyword">byte</span>[] bts = ProxyGenerator.generateProxyClass(<span class="string">&quot;$Proxy0&quot;</span>, <span class="keyword">new</span> Class[]&#123;MDao.class&#125;);</span><br><span class="line">		File file = <span class="keyword">new</span> File(resource.getPath(),<span class="string">&quot;$Proxy0.class&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(!file.exists())&#123;</span><br><span class="line">			file.createNewFile();</span><br><span class="line">		&#125;</span><br><span class="line">		FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">		fos.write(bts);</span><br><span class="line">		fos.flush();</span><br><span class="line">		fos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//加载到内存 Class.forName会在classpath下寻找文件</span></span><br><span class="line">		Class.forName(<span class="string">&quot;com.slorui.$Proxy1&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从网络或磁盘加载类 可以不侵入用户目录</span></span><br><span class="line">		URL[] urls = <span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">&quot;file:/d:/&quot;</span>)&#125;;</span><br><span class="line">		URLClassLoader ul = <span class="keyword">new</span> URLClassLoader(urls);</span><br><span class="line">		Class c = ul.loadClass(<span class="string">&quot;com.slorui.$Proxy1&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 通过反射获取对应的构造器 然后创建对象</span></span><br><span class="line">		Constructor declaredConstructor = 				                    	c.getDeclaredConstructor(InvocationHandler.class);</span><br><span class="line">		Object o = declaredConstructor.newInstance(InvocationHandler.class);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id="继承-2"><a class="markdownIt-Anchor" href="#继承-2"></a> 继承</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line"><span class="comment">// MemberDao不能是final的，final类不能被继承 final方法不能被代理</span></span><br><span class="line">enhancer.setSuperclass(MemberDao.class);</span><br><span class="line">enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> obj		代理对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method	目标方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args		参数</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> proxyMethod		代理方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxyMethod)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;before--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">              <span class="comment">// 不是通过反射调用，而是直接调用方法</span></span><br><span class="line">		proxyMethod.invokeSuper(obj,args);</span><br><span class="line">		log.debug(<span class="string">&quot;after--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">MemberDao memberDao = (MemberDao) enhancer.create();</span><br><span class="line">memberDao.query(<span class="number">1</span>,<span class="string">&quot;xx&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4>
<table>
<thead>
<tr>
<th style="text-align:left">代理方式</th>
<th>实现</th>
<th>优点</th>
<th>缺点</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JDK静态代理</td>
<td>代理类与委托类实现同一接口，并且在代理类中需要硬编码接口</td>
<td>实现简单，容易理解</td>
<td>代理类需要硬编码接口，在实际应用中可能会导致重复编码，浪费存储空间并且效率很低</td>
<td>好像没啥特点</td>
</tr>
<tr>
<td style="text-align:left">JDK动态代理</td>
<td>代理类与委托类实现同一接口，主要是通过代理类实现InvocationHandler并重写invoke方法来进行动态代理的，在invoke方法中将对方法进行增强处理</td>
<td>不需要硬编码接口，代码复用率高</td>
<td>只能够代理实现了接口的委托类</td>
<td>底层使用反射机制进行方法的调用</td>
</tr>
<tr>
<td style="text-align:left">CGLIB动态代理</td>
<td>代理类将委托类作为自己的父类并为其中的非final委托方法创建两个方法，一个是与委托方法签名相同的方法，它在方法中会通过super调用委托方法；另一个是代理类独有的方法。在代理方法中，它会判断是否存在实现了MethodInterceptor接口的对象，若存在则将调用intercept方法对委托方法进行代理</td>
<td>可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口</td>
<td>可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口不能对final类以及final方法进行代理</td>
<td>底层使用反射机制进行方法的调用</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/26/spring/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" data-id="ckmromksd0003awvxheso3nlz" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; pre</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">next &amp;raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Blog</h1>
    <h2 class="blog-subtitle"></h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/20210321171549.jpg">
    <h2 class="author">Slorui</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>65</strong><br>文章</div></a>
      <a href="/categories"><div><strong>10</strong><br>分类</div></a>
      <a href="/tags"><div><strong>15</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/slorui" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2020 - 2021 Slorui<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a target="_blank" rel="noopener" href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  
<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">

  
<script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>




  
<link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">

  
<script src="/plugin/galmenu/GalMenu.js"></script>

  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/categories" title="" class="menuItem">分类</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="/xxxxxxxxx" title="" class="menuItem">xxx</a>
          
            <a href="/xxxxxxx" title="" class="menuItem">xxxx</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>

<script src="/js/script.js"></script>




  </div>
</body>
</html>