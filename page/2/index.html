<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Slorui">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/plugin/bganimation/bg.css">

  

  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" rel="stylesheet" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/20210321171549.jpg">
    <h2 class="author">Slorui</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>50</strong><br>文章</div></a>
      <a href="/categories"><div><strong>8</strong><br>分类</div></a>
      <a href="/tags"><div><strong>12</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main">
  
    <article id="post-spring/beanFactoryAPI" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/29/spring/beanFactoryAPI/" class="article-date">
  <time class="post-time" datetime="2021-03-29T11:40:50.183Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">29</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/29/spring/beanFactoryAPI/">beanFactoryAPI</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="beanfactoryapi"><a class="markdownIt-Anchor" href="#beanfactoryapi"></a> beanFactoryAPI</h3>
<h4 id="获取beanfacotry"><a class="markdownIt-Anchor" href="#获取beanfacotry"></a> 获取BeanFacotry</h4>
<p>通过实现<code>BeanFactoryPostProcessor</code>获得<code>ConfigurableListableBeanFactory</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIgnoreDependencyType</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ignoredependencytype"><a class="markdownIt-Anchor" href="#ignoredependencytype"></a> ignoreDependencyType</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Ignore the given dependency type for autowiring:</span></span><br><span class="line"><span class="comment"> * for example, String. Default is none.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type the dependency type to ignore</span></span><br><span class="line"><span class="comment"> * 忽略自动装配的类型(byType、byName) （CONSTRUCTOR方式不能忽略，再创建bean还没注入时已经把类注入了）</span></span><br><span class="line"><span class="comment"> * 如果属性是自动注入会忽略 但是Autowired不属于自动注入，是手动注入 所以不会被忽略</span></span><br><span class="line"><span class="comment"> * 只能通过修改被注入类的注入模型实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ignoreDependencyType</span><span class="params">(Class&lt;?&gt; type)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// 获取类的beanDefinition</span></span><br><span class="line">    GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置自动注入模型</span></span><br><span class="line">    beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">    <span class="comment">// 设置自动注入时忽略的类</span></span><br><span class="line">    beanFactory.ignoreDependencyType(B.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">	B b;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123;</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;bean-b:&#123;&#125;&quot;</span>,b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ignoredependencyinterface"><a class="markdownIt-Anchor" href="#ignoredependencyinterface"></a> ignoreDependencyInterface</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果类实现了有setX方法的接口，则在（自动注入）时会忽略该类对应的set方法</span></span><br><span class="line"><span class="comment"> * 实现了spring的Aware就是在注入时忽略了（自动注入），而是在调用Aware后置处理器时才会执行对应的set方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ignoreDependencyInterface</span><span class="params">(Class&lt;?&gt; ifc)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    GenericBeanDefinition beanDefinitionA = (GenericBeanDefinition) beanFactory.getBeanDefinition(<span class="string">&quot;y&quot;</span>);</span><br><span class="line">    beanDefinitionA.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">    <span class="comment">// 需要在自动注入模式下</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(X.class);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setW</span><span class="params">(W w)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Y</span> <span class="keyword">implements</span> <span class="title">X</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	W w;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setW</span><span class="params">(W w)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 自动注入模式下，通过忽略接口X可以使W不会自动注入</span></span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="registerresolvabledependency"><a class="markdownIt-Anchor" href="#registerresolvabledependency"></a> registerResolvableDependency</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给指定类型的依赖注入特定的值（没有说自动注入，非自动注入也可以）</span></span><br><span class="line"><span class="comment"> * 当有多个注入类型时，这种设置方式可以使得有确定的注入类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerResolvableDependency</span><span class="params">(Class&lt;?&gt; dependencyType, <span class="meta">@Nullable</span> Object autowiredValue)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// 注入c接口时指定使用D类来注入</span></span><br><span class="line">    beanFactory.registerResolvableDependency(C.class,<span class="keyword">new</span> D());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="clearmetadatacache"><a class="markdownIt-Anchor" href="#clearmetadatacache"></a> clearMetadataCache</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清空beanDefinition缓存， 缓存-属性填充时会缓存的bd</span></span><br><span class="line"><span class="comment"> * getBean()时，spring会去把beanDefinitionMap的beanDefinition进行merge</span></span><br><span class="line"><span class="comment"> * 然后放入mergedBeanDefinition</span></span><br><span class="line"><span class="comment"> * 清空缓存就是标记了mergedBeanDefinition需要合并</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearMetadataCache</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>DefaultListableBeanFactory#clearMetadataCache</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearMetadataCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 会判断beanFactory是否被冻结</span></span><br><span class="line"><span class="comment">		 * 如果被冻结，会标记位需要reMerge</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">    <span class="keyword">super</span>.clearMetadataCache();</span><br><span class="line">    <span class="keyword">this</span>.mergedBeanDefinitionHolders.clear();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 因为需要重新merge，所以allBeanNamesByType</span></span><br><span class="line"><span class="comment">	 * 和singletonBeanNamesByType两个map也需要失效</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    clearByTypeCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="freezeconfiguration"><a class="markdownIt-Anchor" href="#freezeconfiguration"></a> freezeConfiguration</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 冻结容器，所有修改只修改到了beanDefinitionMap</span></span><br><span class="line"><span class="comment"> * getBean()获取mergedBeanDefinition不会被修改影响</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freezeConfiguration</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="isconfigurationfrozen"><a class="markdownIt-Anchor" href="#isconfigurationfrozen"></a> isConfigurationFrozen</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否冻结</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isConfigurationFrozen</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="preinstantiatesingletons"><a class="markdownIt-Anchor" href="#preinstantiatesingletons"></a> preInstantiateSingletons</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实例化所以单例bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException</span>;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/29/spring/beanFactoryAPI/" data-id="ckmuoxf260001pwvx9x3975q7" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/mybatis/自定义mybatis扫描" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/27/spring/mybatis/%E8%87%AA%E5%AE%9A%E4%B9%89mybatis%E6%89%AB%E6%8F%8F/" class="article-date">
  <time class="post-time" datetime="2021-03-27T13:45:15.527Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/27/spring/mybatis/%E8%87%AA%E5%AE%9A%E4%B9%89mybatis%E6%89%AB%E6%8F%8F/">自定义mybatis</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/mybatis/">mybatis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="自定义mybatis"><a class="markdownIt-Anchor" href="#自定义mybatis"></a> 自定义mybatis</h3>
<ol>
<li>
<p>创建自定义扫描注解<code>DaoScannerRegister</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(DaoScannerRegister.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DaoScan &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">basePackage</span><span class="params">()</span> </span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建扫描注册器<code>DaoScannerRegister</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoScannerRegister</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过DaoScan注解获取basePackage信息</span></span><br><span class="line">		AnnotationAttributes mapperScanAttrs = AnnotationAttributes</span><br><span class="line">				.fromMap(importingClassMetadata.getAnnotationAttributes(DaoScan.class.getName()));</span><br><span class="line">		String basePackage = mapperScanAttrs.getString(<span class="string">&quot;basePackage&quot;</span>);</span><br><span class="line">        <span class="comment">// 注册DaoScannerConfig类</span></span><br><span class="line">		BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(DaoScannerConfig.class);</span><br><span class="line">		beanDefinitionBuilder.addPropertyValue(<span class="string">&quot;basePackage&quot;</span>,basePackage);</span><br><span class="line">		registry.registerBeanDefinition(<span class="string">&quot;daoScanner&quot;</span>,beanDefinitionBuilder.getBeanDefinition());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建扫描配置类<code>DaoScannerConfig</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现BeanDefinitionRegistryPostProcessor,注册新的BeanDefination</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoScannerConfig</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String basePackage;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScannerConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">// 创建数据域</span></span><br><span class="line">		DriverManagerDataSource driverManagerDataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">		driverManagerDataSource.setDriverClassName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">		driverManagerDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/eesy&quot;</span>);</span><br><span class="line">		driverManagerDataSource.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">		driverManagerDataSource.setPassword(<span class="string">&quot;1234&quot;</span>);</span><br><span class="line">		<span class="comment">// 构建事务工厂</span></span><br><span class="line">		TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">		<span class="comment">// 创建环境</span></span><br><span class="line">		Environment environment = <span class="keyword">new</span> Environment(<span class="string">&quot;development&quot;</span>, transactionFactory, driverManagerDataSource);</span><br><span class="line">		<span class="comment">// 构建配置类</span></span><br><span class="line">		Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line">		<span class="comment">// 获取sqlSession工厂</span></span><br><span class="line">		<span class="keyword">this</span>.sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBasePackage</span><span class="params">(String basePackage)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.basePackage = basePackage;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException 	</span>&#123;</span><br><span class="line">        <span class="comment">// 创建自定义扫描类</span></span><br><span class="line">		DaoScanner daoScanner = <span class="keyword">new</span> DaoScanner(registry);</span><br><span class="line">        <span class="comment">// 增加过滤器 允许SimpleMetadataReader</span></span><br><span class="line">		daoScanner.registerFilters();</span><br><span class="line">        <span class="comment">// 传入sqlSessionFactory</span></span><br><span class="line">		daoScanner.setSqlSessionFactory(<span class="keyword">this</span>.sqlSessionFactory);</span><br><span class="line">        <span class="comment">// 调用spring的扫描方法 然后转到DaoScanner的扫描方法</span></span><br><span class="line">		daoScanner.scan(basePackage);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException 		</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建自定义扫描类<code>DaoScanner</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoScanner</span> <span class="keyword">extends</span> <span class="title">ClassPathBeanDefinitionScanner</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 保持sqlSessionFactory以便传给DaoFactoryBean</span></span><br><span class="line">	<span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionFactory</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 添加过滤器 这里允许了任何类都通过 mybatis也是这样</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerFilters</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">		addIncludeFilter((metadataReader, metadataReaderFactory) -&gt; <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重写父类ClassPathBeanDefinitionScanner的判断，允许接口被候选</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isCandidateComponent</span><span class="params">(AnnotatedBeanDefinition beanDefinition)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> beanDefinition.getMetadata().isInterface() &amp;&amp; beanDefinition.getMetadata().isIndependent();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 重写父类扫描</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">doScan</span><span class="params">(String... basePackages)</span> </span>&#123;</span><br><span class="line">		Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">super</span>.doScan(basePackages);</span><br><span class="line">		postProcessBeanDefinition(beanDefinitions);</span><br><span class="line">		<span class="keyword">return</span> beanDefinitions;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 后置处理,将mapper接口的beanDefinition转化为DaoFactoryBean，并传入sqlSessionFactory</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinition</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span></span>&#123;</span><br><span class="line">		GenericBeanDefinition beanDefinition = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">for</span>(BeanDefinitionHolder holder: beanDefinitions)&#123;</span><br><span class="line">			beanDefinition = (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line">			String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">			beanDefinition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);</span><br><span class="line">			beanDefinition.setBeanClass(DaoFactoryBean.class);</span><br><span class="line">			beanDefinition.getPropertyValues().add(<span class="string">&quot;sqlSessionFactory&quot;</span>,<span class="keyword">this</span>.sqlSessionFactory);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry, useDefaultFilters);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters, Environment environment)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry, useDefaultFilters, environment);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoScanner</span><span class="params">(BeanDefinitionRegistry registry, <span class="keyword">boolean</span> useDefaultFilters, Environment environment, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(registry, useDefaultFilters, environment, resourceLoader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建<code>DaoFactoryBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoFactoryBean</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">// 要创建的mapper的接口类型</span></span><br><span class="line">	Class&lt;T&gt; daoInterface;</span><br><span class="line">	</span><br><span class="line">	SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSqlSessionFactory</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DaoFactoryBean</span><span class="params">(Class&lt;T&gt; daoInterface)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.daoInterface = daoInterface;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 将mapper保存到knowMapper中，以便后续创建代理对象</span></span><br><span class="line">		sqlSessionFactory.getConfiguration().addMapper(daoInterface);</span><br><span class="line">		<span class="keyword">return</span> sqlSessionFactory.openSession().getMapper(daoInterface);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="comment">// 这里一定要返回接口类型，不然无法注入</span></span><br><span class="line">		<span class="keyword">return</span> daoInterface;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/27/spring/mybatis/%E8%87%AA%E5%AE%9A%E4%B9%89mybatis%E6%89%AB%E6%8F%8F/" data-id="ckmuoxf2h0004pwvxhw11csps" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/mybatis/mybatis扫描原理" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/27/spring/mybatis/mybatis%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="post-time" datetime="2021-03-27T11:34:16.778Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/27/spring/mybatis/mybatis%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86/">mybatis扫描原理</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/mybatis/">mybatis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="mybatis扫描原理"><a class="markdownIt-Anchor" href="#mybatis扫描原理"></a> mybatis扫描原理</h3>
<ol>
<li>
<p>MapperScan导入了<code>MapperScannerRegistrar</code>类，该类继承了<code>ImportBeanDefinitionRegistrar</code>，可以进行新的<code>beanDefinition</code>注册</p>
<p><img src="images/image-20210327193702843.png" alt="image-20210327193702843" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperScannerRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">ResourceLoaderAware</span></span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>MapperScannerRegistrar</code>注册了<code>MapperScannerConfigurer</code>类，该类实现了<code>BeanDefinitionRegistryPostProcessor</code>，在注册<code>beanDefinition</code>后进行了后置处理</p>
<p><img src="images/image-20210329091956851.png" alt="image-20210329091956851" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperScannerConfigurer</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>, <span class="title">InitializingBean</span>, <span class="title">ApplicationContextAware</span>, <span class="title">BeanNameAware</span></span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>MapperScannerConfigurer</code>的<code>postProcessBeanDefinitionRegistry</code>进行了包扫描</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassPathMapperScanner scanner = <span class="keyword">new</span> ClassPathMapperScanner(registry);</span><br><span class="line">scanner.scan()</span><br></pre></td></tr></table></figure>
<p>**<code>ClassPathMapperScanner</code>是<code>ClassPathBeanDefinitionScanner</code>**的子类，这里scan调用了父类的scan方法，然后执行了子类的doScan</p>
<p><code>ClassPathBeanDefinitionScanner</code></p>
</li>
</ol>
<p><img src="images/image-20210327195223282.png" alt="image-20210327195223282" /></p>
<p><code>ClassPathMapperScanner</code></p>
<p><img src="images/image-20210327195433602.png" alt="image-20210327195433602" /></p>
<ol start="4">
<li>
<p><code>processBeanDefinitions</code>进行了类的替换，把所有的mapper替换成了<code>mapperFacotryBean</code></p>
<p><img src="images/image-20210327195533926.png" alt="image-20210327195533926" /></p>
<ol>
<li>
<p>获取mapper的类名</p>
</li>
<li>
<p>把mapper类放入<code>beanDefinition的</code>构造器中，作为<code>mapperFacotryBean</code>的<code>mapperInterface</code>，进行后续代理注入容器</p>
<p><img src="images/image-20210327195745251.png" alt="image-20210327195745251" /></p>
</li>
<li>
<p>把当前<code>beanDefinition</code>替换为<code>mapperFacotryBean</code></p>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/27/spring/mybatis/mybatis%E6%89%AB%E6%8F%8F%E5%8E%9F%E7%90%86/" data-id="ckmromktc000cawvxgr8t0m7q" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/mybatis/mybatis基本配置" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/27/spring/mybatis/mybatis%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/" class="article-date">
  <time class="post-time" datetime="2021-03-27T06:20:24.316Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">27</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/27/spring/mybatis/mybatis%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/">mybatis基本配置</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/mybatis/">mybatis</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="mybatis基本配置"><a class="markdownIt-Anchor" href="#mybatis基本配置"></a> mybatis基本配置</h3>
<h4 id="使用xml"><a class="markdownIt-Anchor" href="#使用xml"></a> 使用xml</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/mybatis/example/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">&quot;org/mybatis/example/mybatis-config.xml&quot;</span>;</span><br><span class="line">InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br></pre></td></tr></table></figure>
<h4 id="不使用xml"><a class="markdownIt-Anchor" href="#不使用xml"></a> 不使用xml</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建数据域</span></span><br><span class="line">DataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line"><span class="comment">// 构建事务工厂</span></span><br><span class="line">TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line"><span class="comment">// 创建环境</span></span><br><span class="line">Environment environment = <span class="keyword">new</span> Environment(<span class="string">&quot;development&quot;</span>, transactionFactory, dataSource);</span><br><span class="line"><span class="comment">// 构建配置类</span></span><br><span class="line">Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line"><span class="comment">// 添加mapper文件</span></span><br><span class="line">configuration.addMapper(BlogMapper.class);</span><br><span class="line"><span class="comment">// 获取sqlSession工厂</span></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br></pre></td></tr></table></figure>
<h4 id="执行sql"><a class="markdownIt-Anchor" href="#执行sql"></a> 执行sql</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">Blog blog = (Blog) session.selectOne(<span class="string">&quot;org.mybatis.example.BlogMapper.selectBlog&quot;</span>, <span class="number">101</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BlogMapper mapper = session.getMapper(BlogMapper.class);</span><br><span class="line">Blog blog = mapper.selectBlog(<span class="number">101</span>);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/27/spring/mybatis/mybatis%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/" data-id="ckmromktc000bawvxgc3k02g8" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mybatis/" rel="tag">mybatis</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/动态代理" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/26/spring/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" class="article-date">
  <time class="post-time" datetime="2021-03-26T08:12:42.541Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">26</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/26/spring/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">动态代理</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="动态代理"><a class="markdownIt-Anchor" href="#动态代理"></a> 动态代理</h3>
<h4 id="静态代理"><a class="markdownIt-Anchor" href="#静态代理"></a> 静态代理</h4>
<h5 id="继承"><a class="markdownIt-Anchor" href="#继承"></a> 继承</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberDao</span> <span class="keyword">implements</span> <span class="title">MDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;---------query-----------logic&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> name+<span class="string">&quot;-return&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> * MDaoSubLog：代理类会继承目标类 代理对象是子孩子 目标对象是父亲</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDaoSubLog</span>  <span class="keyword">extends</span> <span class="title">MemberDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;xxx====proxy&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.query(id,name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="接口"><a class="markdownIt-Anchor" href="#接口"></a> 接口</h5>
<ol>
<li><strong>代理类要实现和目标类同一个接口</strong></li>
<li><strong>代理类包含目标对象</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 目标对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberDao</span> <span class="keyword">implements</span> <span class="title">MDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id,String name)</span></span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;---------query-----------logic&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> name+<span class="string">&quot;-return&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> * 代理对象 proxyObejct</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDaoTime</span> <span class="keyword">implements</span> <span class="title">MDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 目标对象 targetObject</span></span><br><span class="line"><span class="comment">	 * 这里是逻辑写法 MemberDao memberDao</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	MDao mDao;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化mDao</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> mDao</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MDaoTime</span><span class="params">(MDao mDao)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.mDao = mDao;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">query</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">		String result = mDao.query(id,name);</span><br><span class="line">		log.debug(<span class="string">&quot;xxx====proxy&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="缺点"><a class="markdownIt-Anchor" href="#缺点"></a> 缺点</h5>
<ol>
<li>会产生很多代理类</li>
<li>产生的代理类只能代理既定的接口</li>
</ol>
<h4 id="动态代理-2"><a class="markdownIt-Anchor" href="#动态代理-2"></a> 动态代理</h4>
<h5 id="接口-2"><a class="markdownIt-Anchor" href="#接口-2"></a> 接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">MDao memberDao = <span class="keyword">new</span> MemberDao();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * newPorxyInstance</span></span><br><span class="line"><span class="comment">		 * 1. 产生一段字符串 代理类的源码</span></span><br><span class="line"><span class="comment">		 * 2. 把字符串输出到.java($Proxy.java)文件中</span></span><br><span class="line"><span class="comment">		 * 3. 会把$Proxy.class动态编译成$Proxy.class文件</span></span><br><span class="line"><span class="comment">		 * 4. 会通过类加载器把$Proxy.class加载到JVM中</span></span><br><span class="line"><span class="comment">		 * 5. Class.forName(&quot;XXXX&quot;).newInstance 反射实例化这个对象</span></span><br><span class="line"><span class="comment">		 * 6. 直接在内存中产生了字节码，然后装载到jvm</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		MDao mDao = (MDao) Proxy.newProxyInstance(Test.class.getClassLoader(),</span><br><span class="line">				<span class="keyword">new</span> Class[]&#123;MDao.class&#125;,</span><br><span class="line">				<span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">						log.debug(<span class="string">&quot;before--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">						method.invoke(memberDao, args);</span><br><span class="line">						log.debug(<span class="string">&quot;after--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">		mDao.query(<span class="number">1</span>,<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 把内存字节码输出到文件 就可以看到代理类的内容</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// 获取当前类的跟路径</span></span><br><span class="line">		URL resource = Test.class.getClass().getResource(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">		<span class="comment">// 获取代理类的字节</span></span><br><span class="line">		<span class="keyword">byte</span>[] bts = ProxyGenerator.generateProxyClass(<span class="string">&quot;$Proxy0&quot;</span>, <span class="keyword">new</span> Class[]&#123;MDao.class&#125;);</span><br><span class="line">		File file = <span class="keyword">new</span> File(resource.getPath(),<span class="string">&quot;$Proxy0.class&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(!file.exists())&#123;</span><br><span class="line">			file.createNewFile();</span><br><span class="line">		&#125;</span><br><span class="line">		FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">		fos.write(bts);</span><br><span class="line">		fos.flush();</span><br><span class="line">		fos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//加载到内存 Class.forName会在classpath下寻找文件</span></span><br><span class="line">		Class.forName(<span class="string">&quot;com.slorui.$Proxy1&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从网络或磁盘加载类 可以不侵入用户目录</span></span><br><span class="line">		URL[] urls = <span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">&quot;file:/d:/&quot;</span>)&#125;;</span><br><span class="line">		URLClassLoader ul = <span class="keyword">new</span> URLClassLoader(urls);</span><br><span class="line">		Class c = ul.loadClass(<span class="string">&quot;com.slorui.$Proxy1&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 通过反射获取对应的构造器 然后创建对象</span></span><br><span class="line">		Constructor declaredConstructor = 				                    	c.getDeclaredConstructor(InvocationHandler.class);</span><br><span class="line">		Object o = declaredConstructor.newInstance(InvocationHandler.class);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id="继承-2"><a class="markdownIt-Anchor" href="#继承-2"></a> 继承</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line"><span class="comment">// MemberDao不能是final的，final类不能被继承 final方法不能被代理</span></span><br><span class="line">enhancer.setSuperclass(MemberDao.class);</span><br><span class="line">enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> obj		代理对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> method	目标方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args		参数</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> proxyMethod		代理方法</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxyMethod)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		log.debug(<span class="string">&quot;before--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">              <span class="comment">// 不是通过反射调用，而是直接调用方法</span></span><br><span class="line">		proxyMethod.invokeSuper(obj,args);</span><br><span class="line">		log.debug(<span class="string">&quot;after--------------xxxxxxxxxxx----------proxy&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">MemberDao memberDao = (MemberDao) enhancer.create();</span><br><span class="line">memberDao.query(<span class="number">1</span>,<span class="string">&quot;xx&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4>
<table>
<thead>
<tr>
<th style="text-align:left">代理方式</th>
<th>实现</th>
<th>优点</th>
<th>缺点</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JDK静态代理</td>
<td>代理类与委托类实现同一接口，并且在代理类中需要硬编码接口</td>
<td>实现简单，容易理解</td>
<td>代理类需要硬编码接口，在实际应用中可能会导致重复编码，浪费存储空间并且效率很低</td>
<td>好像没啥特点</td>
</tr>
<tr>
<td style="text-align:left">JDK动态代理</td>
<td>代理类与委托类实现同一接口，主要是通过代理类实现InvocationHandler并重写invoke方法来进行动态代理的，在invoke方法中将对方法进行增强处理</td>
<td>不需要硬编码接口，代码复用率高</td>
<td>只能够代理实现了接口的委托类</td>
<td>底层使用反射机制进行方法的调用</td>
</tr>
<tr>
<td style="text-align:left">CGLIB动态代理</td>
<td>代理类将委托类作为自己的父类并为其中的非final委托方法创建两个方法，一个是与委托方法签名相同的方法，它在方法中会通过super调用委托方法；另一个是代理类独有的方法。在代理方法中，它会判断是否存在实现了MethodInterceptor接口的对象，若存在则将调用intercept方法对委托方法进行代理</td>
<td>可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口</td>
<td>可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口不能对final类以及final方法进行代理</td>
<td>底层使用反射机制进行方法的调用</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/26/spring/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" data-id="ckmromksd0003awvxheso3nlz" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/自定义注解" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/26/spring/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3/" class="article-date">
  <time class="post-time" datetime="2021-03-26T06:25:40.999Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">26</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/26/spring/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3/">自定义注解</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="自定义注解"><a class="markdownIt-Anchor" href="#自定义注解"></a> 自定义注解</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设定声明周期 SOURCE:源代码java期  CLASS:class类期间  RUNTIME:运行期</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="comment">// 指定注解位置TYEP FIELD METHOD PARAMETER CONSTRUCTOR LOCAL_VARIABLE ANNOTATION_TYPE PACKAGE TYPE_PARAMETER TYPE_USE</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Slorui &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 不填default 必须@Slorui(&quot;XX&quot;) value不用显示写出来</span></span><br><span class="line">	<span class="comment">// 如果多个属性，value必须写出来</span></span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">age</span><span class="params">()</span> <span class="keyword">default</span> 2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/26/spring/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3/" data-id="ckmromksh0005awvxdli57uk1" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-spring/源码编译" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/26/spring/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" class="article-date">
  <time class="post-time" datetime="2021-03-26T06:13:16.912Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">26</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/26/spring/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/">源码编译</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="源码编译"><a class="markdownIt-Anchor" href="#源码编译"></a> 源码编译</h4>
<ol>
<li>
<p>github/gitee下载spring-framework源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b xxx分支（版本号） git@xxxxxxxxxxxxxx  </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改源码内gradle\wrapper\gradle-wrapper.properties文件url，url对应下载好的zip文件位置</p>
<p>去gradle网站下载对应的zip包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">distributionBase=GRADLE_USER_HOME</span><br><span class="line">distributionPath=wrapper/dists</span><br><span class="line">distributionUrl=file\:///G\:/code/spring/gradle-5.6.4-bin.zip</span><br><span class="line">zipStoreBase=GRADLE_USER_HOME</span><br><span class="line">zipStorePath=wrapper/dists</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>执行<code>gradlew :spring-oxm:compileTestJava</code>编译oxm项目</p>
</li>
<li>
<p>项目导入ideal，设置ideal的gradle形式</p>
<p><img src="images/image-20210326142017038.png" alt="image-20210326142017038" /></p>
</li>
<li>
<p>等待idea建立索引，此时项目已经建立完成</p>
</li>
<li>
<p>在项目新建module，在build-gradle添加依赖，可以从其他包的依赖观察如何写</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ependencies &#123;</span><br><span class="line">    <span class="comment">// spring核心依赖 spring-context 一个context就能完成基本开发</span></span><br><span class="line">    <span class="keyword">compile</span>(<span class="keyword">project</span>(<span class="string">&quot;:spring-context&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>建立项目并执行代码，会遇到错误，执行core和context包下的test/java的run All tests，把未编译的类进行编译即可。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/26/spring/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" data-id="ckmromktb0009awvxe4mg5qhl" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-kernal/12.内存管理" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/23/kernal/12.%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="article-date">
  <time class="post-time" datetime="2021-03-23T08:51:42.322Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">23</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/23/kernal/12.%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">内存管理</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="内存管理"><a class="markdownIt-Anchor" href="#内存管理"></a> 内存管理</h3>
<h4 id="121-页"><a class="markdownIt-Anchor" href="#121-页"></a> 12.1 页</h4>
<p>内核把物理页作为内存管理的基本单位。尽管处理器最小寻址单位通常是字（甚至字节），但内存管理单元MMU（管理内存并把虚拟地址转化为物理地址的硬件）通常以页单位进行处理。MMU以页大小为单位管理系统的页表。从虚拟内存来看，页就是最小单位。</p>
<p>大多数32位系统支持4KB的页，64位系统一般支持8KB的页。</p>
<p>内核用struct_page表示系统的每个物理页。</p>
<p>flag域存放页的状态：是否脏页、是否锁定再内存等。每一位表示一个状态，可以表示32种不同状态。</p>
<p>count域存放页的计数引用。当为-1时，表示没有引用。内核代码不应该直接检测该域，而是通过函数查看，返回0时表示空闲页。一个页可以由页缓存使用（mapping域指向和这个页关联的对象）、作为私有数据（由private指向）、或者作为进程页表中的映射。</p>
<p>virtual域是页的虚拟地址。就是页再虚拟内存中的地址。有些高端内存并不永久映射到内核地址空间，这时为null，当使用时动态映射。</p>
<p>这个数据结构描述物理内存本身，并不保护其中的数据。</p>
<p>内核用这一结构管理系统所有的页，内核需要知道一个页当前的状态（空闲、被谁拥有等）</p>
<h4 id="122-区"><a class="markdownIt-Anchor" href="#122-区"></a> 12.2 区</h4>
<p>由于硬件限制，内核不能对所有页一视同仁。有些页位于特定的物理地址，不能用作一些特定任务。内核把页分为不同的区，使用区对具有相似特性的页分组。linux必须处理一下两种硬件缺陷引起的内存寻址问题：</p>
<ol>
<li>一些硬件只能用某些特定的内存地址指向DMA（直接内存访问）</li>
<li>一些体系结构的内存的物理寻址范围比虚拟寻址范围大的多，有些内存无法映射到内核空间。</li>
</ol>
<p>linux主要使用了四种区：</p>
<ol>
<li>ZONE_DMA：这个区的页能用来执行DMA</li>
<li>ZONE_DMA32：和MDA相似，但是只能被32为设备访问。比DMA更大</li>
<li>ZONE_NORMAL：正常映射的页</li>
<li>ZONE_HIGNEM：高端内存，并不能永久映射到内核地址空间。</li>
</ol>
<p>区的使用和分布和体系结构相关。</p>
<p>每个区都用struct zone定义：</p>
<p>lock域是一个自旋锁，防止该结构被并发访问。这个域只保护结构，不保护区内的页。没有特定数据结构保护单个页，但是部分内核可以锁住页中驻留的数据</p>
<p>watermark数组维持该区的最小值、最底和最高水位值。内核使用水位为每个区设定合适的内存消耗基准</p>
<p>name域是区的名字</p>
<h4 id="123-获得页"><a class="markdownIt-Anchor" href="#123-获得页"></a> 12.3 获得页</h4>
<p>内核提供了一种请求内存的底层机制，并提供了访问的接口，都以页为单位分配</p>
<h5 id="1231-获得填充为0的页"><a class="markdownIt-Anchor" href="#1231-获得填充为0的页"></a> 12.3.1 获得填充为0的页</h5>
<p>可以让返回的页内容全为0。为了防止返回给用户的页有敏感信息，数据必须填充为0</p>
<h5 id="1232-释放页"><a class="markdownIt-Anchor" href="#1232-释放页"></a> 12.3.2 释放页</h5>
<p>释放页时，只能释放自己的页。</p>
<h4 id="124-kmalloc"><a class="markdownIt-Anchor" href="#124-kmalloc"></a> 12.4 kmalloc()</h4>
<p>对于常用字节为单位的分配来说，内核提供了kmalloc()，比malloc()多了个flags参数，出错返回null</p>
<h5 id="1241-gfp_mask标志"><a class="markdownIt-Anchor" href="#1241-gfp_mask标志"></a> 12.4.1 gfp_mask标志</h5>
<p>不管低级页分配函数函数kmalloc，都使用了分配器标志，可以分为三类：行为修饰符、区修饰符和类型。</p>
<p>行为修饰符：表示内核应该如何分配所需的内存（例如中断分配内存要求内核不能睡眠）</p>
<p>区修饰符：从哪分配内存</p>
<p>类型：组合行为修饰符和区修饰符</p>
<h5 id="1242-kfree"><a class="markdownIt-Anchor" href="#1242-kfree"></a> 12.4.2 kfree()</h5>
<p>释放kmalloc()内存块。</p>
<h4 id="125-vmalloc"><a class="markdownIt-Anchor" href="#125-vmalloc"></a> 12.5 vmalloc()</h4>
<p>vmalloc和malloc都保证虚拟地址的连续性，不保证物理地址的连续，malloc保证物理地址的连续。</p>
<p>vmalloc通过修正页表，把内存映射到逻辑地址的连续区域</p>
<p>大多使情况只有硬件需要连续物理内存地址。因为很多体系结构硬件独立于内存管理系统，不知道虚拟内存。</p>
<p>kmalloc性能更好，因为vmalloc需要地址转化</p>
<h4 id="126-slab层"><a class="markdownIt-Anchor" href="#126-slab层"></a> 12.6 slab层</h4>
<p>为了便于频繁的分配和回收，编程人员常用空闲链表，包含了可以使用的已经分配好的数据结构块。使用时获取一个，不使用时放回链表。</p>
<p>由于内核无法感知空闲链表，就不能再内存紧缺时进行控制。linux通过了slab层，扮演了通用数据结构缓存层的角色</p>
<p>slab原则：</p>
<ol>
<li>频繁使用的数据结构也会频繁分配和释放，应当缓存</li>
<li>频繁分配和回收会导致内存碎片，为了避免，空闲链表会连续的存放，不会导致内存碎片</li>
<li>回收的对象立即投入下一次分配</li>
<li>如果分配器知道对象大小，页大小等概念，可以更明智的决策</li>
<li>如果部分缓存属于单个处理器，可以不加锁</li>
</ol>
<h5 id="1261-slab层设计"><a class="markdownIt-Anchor" href="#1261-slab层设计"></a> 12.6.1 slab层设计</h5>
<p>slab层把不同的对象划分到所谓的高速缓存组，每个组存放不同类型的对象。每种对象对应一个高速缓存</p>
<p>例如一个高速缓存存放进程描述符，另一个存放索引节点对象。kmalloc再slab之上，使用了一组通用高速缓存</p>
<p>高速缓存又被花费为slab。slab由一个或多个物理上连续的页组成，一般由一个页。每个高速缓存可以由多个slab组成。</p>
<p>slab分为：满、部分满和空。先从部分满分配，然后分配空，不足创建新的slab。</p>
<p>slab只有再下列情况释放空间：</p>
<ol>
<li>内存变得紧缺</li>
<li>系统试图释放更多内存使用</li>
<li>高速缓存被显示撤销</li>
</ol>
<p>slab负责内存紧缺的情况下所有底层的对齐、着色、分配和释放等。</p>
<h4 id="17-再栈上的静态分配"><a class="markdownIt-Anchor" href="#17-再栈上的静态分配"></a> 1.7 再栈上的静态分配</h4>
<p>内核栈不能像用户栈一样增长，内核栈小且固定。给每个进程一个固定大小的栈，可以减少内存消耗，也无须承担过多内存管理职责。</p>
<p>通常内核栈是两个页的大小。历史上中断处理程序和中断进程共享一个栈，当1页的栈被允许时，中断处理程序就使用自己的1页中断栈。</p>
<p>再栈上进行大量静态分配是危险的。数据溢出首先威胁thread_info结构，紧贴内核栈末端。</p>
<h4 id="128-高端内存映射"><a class="markdownIt-Anchor" href="#128-高端内存映射"></a> 12.8 高端内存映射</h4>
<p>高端内存的页不能永久的映射到内核地址空间。x86中，高于896MB的物理内存范围大都是高端内存。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/23/kernal/12.%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" data-id="ckmromkl30000awvx8pddb1ke" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernal/" rel="tag">kernal</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-kernal/11.定时器和时间管理" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/23/kernal/11.%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/" class="article-date">
  <time class="post-time" datetime="2021-03-23T07:19:14.745Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">23</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/23/kernal/11.%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/">定时器和时间管理</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="定时器和时间管理"><a class="markdownIt-Anchor" href="#定时器和时间管理"></a> 定时器和时间管理</h3>
<p>时间管理在内核非常重要，内核有大量函数都是基于时间驱动的。有些函数周期执行（例如调度程序运行队列进行平衡调整或屏幕刷新等），另一些函数需要等待一个相对时间才运行（需要推后执行的磁盘I/O操作）</p>
<h4 id="111-时间概念"><a class="markdownIt-Anchor" href="#111-时间概念"></a> 11.1 时间概念</h4>
<p>内核必须在硬件帮助下才能计算和管理时间，硬件为内核提高了一个系统定时器计算流逝的时间。系统定时器以某种频率自行触发（称为射中）时钟中断，该频率可以预设，称为节拍率。当时钟中断时，内核通过特殊中断处理程序处理。两次时钟中断的时间就是节拍。</p>
<p>时钟中断对于管理操作系统十分重要，大量内核函数都离不开时间控制：</p>
<ol>
<li>更新系统运行时间</li>
<li>更新实际时间</li>
<li>smp系统上，均衡调度程序中各个处理器的运行队列</li>
<li>检测当前进程时间片是否耗尽</li>
<li>运行超时的动态定时器</li>
<li>更新资源消耗和处理器时间统计</li>
</ol>
<h4 id="112-节拍率hz"><a class="markdownIt-Anchor" href="#112-节拍率hz"></a> 11.2 节拍率HZ</h4>
<p>通过静态预处理定义，x86默认是100。</p>
<p>提高节拍率好处：</p>
<ol>
<li>更新时钟中断解析度可以提高时间驱动事件的解析度</li>
<li>提高了时间驱动时间的准确度</li>
<li>内核定时器以更高的频率和准确度运行</li>
<li>依赖定时执行的系统调用能以更高经度运行</li>
<li>提高进程抢占精度</li>
</ol>
<p>劣势：</p>
<ol>
<li>频率越高，系统负担越重</li>
<li>中断处理程序占用时间增加</li>
<li>增加电耗</li>
</ol>
<p>linux支持无节拍操作，设置了config_hz，系统根据这个选项动态调度时钟中断，并不固定时间间隔出发中断</p>
<h4 id="113-jiffies"><a class="markdownIt-Anchor" href="#113-jiffies"></a> 11.3 jiffies</h4>
<p>jiffies记录系统启动以来的节拍总数。启动时内核初始化为0，每次中断加1。实际上内核给jiffies设置了初值，引起变量不断溢出，由此捕获bug。获得jiffies需要减去偏差</p>
<p>科学中，jiffies表示时间间隔，计算机中表示两个连续时钟周期的时间。</p>
<p>jiffies是无符号长整型(unsigned long)，32位会溢出，64位不会，一般读取低32位</p>
<p>jiffies超出后会回绕到0，有宏帮助解决回绕带来的问题</p>
<p>用户空间的hz可以通过jiffies转化</p>
<h4 id="114-硬时钟和定时器"><a class="markdownIt-Anchor" href="#114-硬时钟和定时器"></a> 11.4 硬时钟和定时器</h4>
<p>体系结构提供了两种设备计数器：系统定时器和实时时钟</p>
<p>实时时钟（RTC）是用来存放系统时间的设备，系统关闭后也可以考主板微型电池保持计时，系统启动时读取RTC初始化墙上时间。</p>
<p>系统定时器是内核定时机制的重要角色，提供一种周期性出发中断机制。有些是通过系统晶振进行分频实现，有些是通过衰减测量器实现中断</p>
<h4 id="115-时钟中断处理程序"><a class="markdownIt-Anchor" href="#115-时钟中断处理程序"></a> 11.5 时钟中断处理程序</h4>
<p>时钟中断可以分为两部分：系统结构相关和体系结构无关部分</p>
<p>与体系结构相关的例程作为系统定时器的中断处理程序注册到内核，产生中断时运行。绝大多数做的工作有：</p>
<ol>
<li>获得xtime_lock锁，对访问jiffies和墙上时间xtime保护</li>
<li>需要时应答或重设系统时钟</li>
<li>周期性读取墙上时间更新实时时钟</li>
<li>调用体系结构无关时钟例程</li>
</ol>
<p>体系结构无关：</p>
<ol>
<li>更新jiffies</li>
<li>更新资源消耗的统计值，如进程消耗的时间系统时间和用户时间</li>
<li>执行已到期的动态定时器</li>
<li>执行scheduler_tick()函数</li>
<li>更新墙上时间</li>
<li>计算平均负载</li>
</ol>
<h4 id="116-实际时间"><a class="markdownIt-Anchor" href="#116-实际时间"></a> 11.6 实际时间</h4>
<p>xtime是实际时间。除了更新xtime时间外，内核不会频繁使用xime，除了文件系统代码存放文件时访问时间戳需要使用xtime</p>
<h4 id="117-定时器"><a class="markdownIt-Anchor" href="#117-定时器"></a> 11.7 定时器</h4>
<p>定时器是管理内核流逝的时间的基础。定时器不周期运行，超时后自动撤销。</p>
<p>定义定时器–&gt;初始化内部值（以节拍位绝对计数值）–&gt;激活定时器</p>
<p>内核保证不会提前运行定时器，但可能会有延误。不能用定时器实现硬实时任务。</p>
<p>定时器和当前代码异步，所以可能产生竞争条件。在多处理机上，要防止并发访问。尤其重点保护定时器中断处理程序中的共享数据。</p>
<p>内核将定时器链表分为五组，定时器超时时间接近时，定时器随组下移，减少搜索带来的负担。</p>
<h4 id="118-延时执行"><a class="markdownIt-Anchor" href="#118-延时执行"></a> 11.8 延时执行</h4>
<p>内核代码（尤其程序驱动）除了使用定时器或下半部机制外，还需要其他方法推迟任务。这种推迟通常发生在等待硬件完工，而且等待时间较短（例如重设网卡以太模式需要2ms，重设后驱动程序需要等待2ms）</p>
<h5 id="1181-忙等待"><a class="markdownIt-Anchor" href="#1181-忙等待"></a> 11.8.1 忙等待</h5>
<p>忙时等待，可以延迟节拍的整数倍时间，适用于不精确。循环中不断等待节拍数耗尽。</p>
<p>忙等待cpu会一直旋转等待，效率很低。这时可以调用调度程序（必须存在更重要的任务运行）。因为调用调度函数，所以不能在中断中运行，</p>
<h5 id="1182-短延时"><a class="markdownIt-Anchor" href="#1182-短延时"></a> 11.8.2 短延时</h5>
<p>有些内核代码（通常驱动程序）不但需要很短暂的延迟（比时钟节拍短），还要求精确。多发生在硬件同步时，内核提供了ms、ns、ms级别的延迟函数。函数通过循环次数来决定延迟（系统知道循环一次的时间）</p>
<h5 id="1183-schedule_timeout"><a class="markdownIt-Anchor" href="#1183-schedule_timeout"></a> 11.8.3 schedule_timeout()</h5>
<p>该方法会让需要延迟执行的任务睡眠到指定的延迟时间耗尽再运行。不能保证正好是指定时间，只能尽量接近延迟时间。睡眠时间结束，内核唤醒任务放入运行队列。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/23/kernal/11.%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/" data-id="ckmromks60001awvx5y9jfd8t" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernal/" rel="tag">kernal</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-算法/链表" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/21/%E7%AE%97%E6%B3%95/%E9%93%BE%E8%A1%A8/" class="article-date">
  <time class="post-time" datetime="2021-03-21T08:53:05.711Z" itemprop="datePublished">
    <span class="post-month">3月</span><br/>
    <span class="post-day">21</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/21/%E7%AE%97%E6%B3%95/%E9%93%BE%E8%A1%A8/">链表</a>
    </h1>
  

        <div>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/algorithm/">algorithm</a>
  </div>

          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/21/%E7%AE%97%E6%B3%95/%E9%93%BE%E8%A1%A8/" data-id="ckmk7003o000r4kvxhfat8718" class="article-share-link">分享</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8/" rel="tag">链表</a></li></ul>

    </footer>
  </div>
  
</article>




  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&amp;laquo; pre</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">next &amp;raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Blog</h1>
    <h2 class="blog-subtitle"></h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/images/20210321171549.jpg">
    <h2 class="author">Slorui</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>50</strong><br>文章</div></a>
      <a href="/categories"><div><strong>8</strong><br>分类</div></a>
      <a href="/tags"><div><strong>12</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/slorui" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2020 - 2021 Slorui<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a target="_blank" rel="noopener" href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  
<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">

  
<script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>




  
<link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">

  
<script src="/plugin/galmenu/GalMenu.js"></script>

  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title="" class="menuItem">首页</a>
          
            <a href="/tags" title="" class="menuItem">标签</a>
          
            <a href="/categories" title="" class="menuItem">分类</a>
          
            <a href="/archives" title="" class="menuItem">归档</a>
          
            <a href="/xxxxxxxxx" title="" class="menuItem">xxx</a>
          
            <a href="/xxxxxxx" title="" class="menuItem">xxxx</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>

<script src="/js/script.js"></script>




  </div>
</body>
</html>